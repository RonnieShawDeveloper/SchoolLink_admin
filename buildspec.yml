version: 1.0
applications:
  - appRoot: .
    env:
      variables:
        APP_ID: d2wwjdgjliumng
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - npx ampx -v
            - npx ampx pipeline-deploy --app-id $APP_ID --branch $AWS_BRANCH
            - FN=$(aws lambda list-functions --region $AWS_REGION --query "Functions[?contains(FunctionName, 'studentSearch')].FunctionName" --output text)
            - FUNCTION_URL=$(aws lambda get-function-url-config --region $AWS_REGION --function-name $FN --query "FunctionUrl" --output text) || true
            - echo "FUNCTION_URL=$FUNCTION_URL"
            - sed -i "s|window.STUDENT_API_BASE.*|window.STUDENT_API_BASE = '${FUNCTION_URL}';|" src/index.html || true
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: dist/SchoolLink
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
